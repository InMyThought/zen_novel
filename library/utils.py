import os
import re
import ebooklib
from ebooklib import epub
from bs4 import BeautifulSoup
from .models import Chapter

def get_epub_metadata(epub_path):
    """
    Fungsi mengambil Metadata: Judul, Penulis, Sinopsis, Genre
    """
    metadata = {
        'title': None,
        'author': "Unknown",
        'synopsis': None,
        'genre': "General"
    }

    try:
        book = epub.read_epub(epub_path)
        
        if book.get_metadata('DC', 'title'):
            metadata['title'] = book.get_metadata('DC', 'title')[0][0]
            
        if book.get_metadata('DC', 'creator'):
            raw_author = book.get_metadata('DC', 'creator')[0][0]
            if raw_author and str(raw_author).strip() != "0":
                metadata['author'] = raw_author

        if book.get_metadata('DC', 'description'):
            raw_desc = book.get_metadata('DC', 'description')[0][0]
            clean_desc = re.sub('<[^<]+?>', '', raw_desc)
            metadata['synopsis'] = clean_desc

        subjects = book.get_metadata('DC', 'subject')
        if subjects:
            genre_list = [s[0] for s in subjects]
            genre_str = ", ".join(genre_list)
            if len(genre_str) > 100:
                genre_str = genre_str[:97] + "..."
            metadata['genre'] = genre_str

        return metadata
    
    except Exception as e:
        print(f"Gagal ekstrak metadata: {e}")
        return metadata

def generate_chapters(novel_instance):
    if not novel_instance.epub_file: return
    file_path = novel_instance.epub_file.path
    
    try:
        if file_path.endswith('.epub'):
            book = epub.read_epub(file_path)
            
            if not novel_instance.title or novel_instance.title == "New Novel":
                meta = get_epub_metadata(file_path)
                if meta['title']:
                    novel_instance.title = meta['title']
                    novel_instance.save()

            order_count = 1 
            
            for item in book.get_items():
                if item.get_type() == ebooklib.ITEM_DOCUMENT:
                    soup = BeautifulSoup(item.get_content(), 'html.parser')
                    full_text_check = soup.get_text().strip()
                    
                    # --- BAGIAN 1: AMBIL JUDUL & HAPUS DARI BODY ---
                    title_tag = soup.find(['h1', 'h2', 'h3', 'title'])
                    
                    if title_tag:
                        title_text = title_tag.get_text().strip()
                        # ACTION PENTING: Hapus tag judul dari pohon HTML
                        # Agar tidak muncul double di frontend
                        title_tag.decompose() 
                    else:
                        title_text = item.get_name()

                    # =========================================
                    #       FILTER: SAMPAH & DAFTAR ISI
                    # =========================================

                    # 1. Judul Blacklist
                    blacklist_titles = ['table of contents', 'contents', 'index', 'daftar isi', 'front page', 'intro page', 'copyright']
                    if title_text.lower() in blacklist_titles:
                        continue
                    
                    # 2. Judul sama dengan Judul Novel
                    if title_text.lower() == novel_instance.title.lower():
                        continue

                    # 3. Filter ID Intro
                    if soup.find("div", id="intro"):
                        continue

                    # 4. Filter Kata Kunci Metadata
                    start_text = full_text_check[:300].lower()
                    if "generated by" in start_text and "lightnovel crawler" in start_text:
                        continue
                    if "source:" in start_text and "http" in start_text:
                        continue

                    # 5. Filter TOC (Kebanyakan kata Chapter)
                    if full_text_check.lower().count("chapter") > 20: 
                        continue

                    # 6. Filter Panjang Teks Minimal (Naikkan jadi 200)
                    if len(full_text_check) < 200:
                        continue 

                    # =========================================
                    #           PROSES KONTEN BERSIH
                    # =========================================
                    
                    body_content = soup.find('body')
                    
                    if body_content:
                        # decode_contents() mengambil isi DI DALAM <body> tanpa tag <body> itu sendiri
                        content_html = body_content.decode_contents()
                    else:
                        content_html = str(soup)

                    # --- CLEANING EXTRA: Hapus '@@@@' atau sampah teks lain ---
                    content_html = content_html.replace('@@@@', '')

                    # Regex Chapter Index
                    match = re.search(r'(?:Chapter|Ch\.?|Episode|^)\s*(\d+(?:\.\d+)?)', title_text, re.IGNORECASE)
                    
                    real_index = 0
                    if match:
                        try:
                            real_index = float(match.group(1))
                        except:
                            real_index = order_count
                    else:
                        if "prologue" in title_text.lower() or "intro" in title_text.lower():
                            real_index = 0
                        else:
                            real_index = order_count

                    Chapter.objects.create(
                        novel=novel_instance, 
                        title=title_text, 
                        content=content_html, # Konten sudah bersih dari Judul & @@@@
                        order=order_count,      
                        chapter_index=real_index 
                    )
                    order_count += 1
                        
        elif file_path.endswith('.txt'):
            with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                content = f.read()
            
            paragraphs = [p.strip() for p in content.split('\n') if p.strip()]
            chunk_size = 50 
            
            for i in range(0, len(paragraphs), chunk_size):
                chunk = paragraphs[i:i+chunk_size]
                body = "".join([f"<p>{p}</p>" for p in chunk])
                chap_num = (i // chunk_size) + 1
                
                Chapter.objects.create(
                    novel=novel_instance, 
                    title=f"Part {chap_num}", 
                    content=body, 
                    order=chap_num,
                    chapter_index=chap_num
                )

    except Exception as e:
        print(f"Error parsing file: {e}")